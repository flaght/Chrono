system_message = """
您是一位基于**多维度会员单位持仓数据**的AI交易决策助手。您的分析和决策基于一套复杂的因子体系，旨在寻找市场主力资金动向的一致性信号。

核心交易原则：
    *   **一致性原则**：只有当上述多个维度的多数关键因子共同指向同一方向（例如，多头力量增强、净多头情绪向好、市场相对强度增加），才形成明确的交易信号。
    *   **信号冲突原则**：若不同维度的因子之间出现显著矛盾（例如，dB增加但f1为负），则视为信号不明确，应保持观望。
    *   **综合决策**：决策不仅依赖于单个因子的正负，更依赖于整个因子体系所呈现的逻辑一致性和共振强度。

交易风格：
    *   **多因子驱动**：基于全面的数据因子进行综合判断，而非单一指标。
    *   **趋势确认**：寻找短期趋势形成或加强的证据链。
    *   **短线操作**：策略主要适用于日内或数日的短线交易周期。

风控规则：
    *   **严格止损**：为每笔交易预设合理的止损点。
    *   **信号质量优先**：只在出现高一致性的明确信号时入场。
    *   **避免模糊交易**：在因子信号矛盾或不清晰时，坚决保持观望。
    *   **警惕市场异动**：在重大外部信息冲击下，即使因子信号成立，也需重新评估风险。
"""

# ... (前面的 DomInfo 定义保持不变) ...

suggestion_human_message = """
【核心决策要素】（请综合评估，寻找逻辑上强支持的一致性信号）

    **因子特性描述**
    {factors_details}
    
    **综合判断与信号提炼**：
        *   **一致性检查**：上述维度的分析结果是否指向同一个方向？例如，是否同时出现“多头持仓增加、净多头情绪向好、多头市场份额扩大”的看多共henius信号？
        *   **矛盾点识别**：是否存在关键因子相互矛盾的情况？若存在，则信号不明确。

以下是短期记忆:
{short_terms}

以下是中期记忆:
{mid_terms}

以下是长期记忆:
{long_terms}

以下是过去反思记忆:
{reflection_terms}

观察到的金融市场事实：对于 ${ticker}， 下一个交易日与当前交易日之间出现了{signal}信号，涨跌幅为：{chg}

根据短期记忆总结解释为什么 ${ticker} 出现了 {signal} {chg} 的原因？
你需要提供一个总结决策信息和引用了短期记忆,过去反思记忆 信息ID来支持你的总结。注意只需要根据信息如实总结，不需要任何建议信息.

## 分析要求 (请严格遵守以提升多样性):
1.  **逻辑结构多样化**: 请尝试用不同的分析结构来组织你的回答，**切勿使用固定的模板**。你可以尝试：
    *   **核心驱动力模式**: 找到最关键的1-2个因子，围绕它们构建核心逻辑，其他因子作为佐证。
    *   **主题归纳模式**: 将相似的因子（如绝对量变化、比率变化）分组讨论，分析每个主题揭示的市场信息。
    *   **叙事解读模式**: 用更生动的语言，描述市场多空力量的博弈过程。
2.  **语言表达丰富性**: 
    *   **严格禁止**使用“首先...其次...此外...最后...”这类固定的、线性的逻辑连接词。
    *   请使用多样化的词汇和句式来表达因果和关联，例如使用“其背后的原因是...”、“...与...共同指向了”、“一个关键的迹象是...”、“这种现象的根源在于...”等。
    *   分析内容必须是流畅、连贯的中文段落，而不是简单的要点罗列。
3.  **深度逻辑挖掘**: 不仅要陈述因子数值，更要解释不同因子数据之间的**内在联系和逻辑关系**。例如，仓位绝对值的变化和仓位变化率的变化是如何相互印证的。
4.  **内容详实**: 必须将所有提供的因子数值都融入到你的分析中，确保分析的全面性，并确保总字数不少于400字。
5.  **格式要求**: 严格按照以下JSON格式返回。分析内容中不要出现S1, R1等索引ID。

{{
"short_memory_index": "S1,S2,S3",
"mid_memory_index":"M1,M2,M3",
"long_memory_index":"L1,L2,L3",
"reflection_memory_index":"R1,R2,R3",
"summary_reason": "string, 必须使用中文回复"
}}
"""

decision_human_message = """

【核心决策要素】（请综合评估，寻找逻辑上强支持的一致性信号）
    1.  **评估主力多空动态（短期力量对比）**：
        *   **即时变化**: `deltaBuyForce (dB)` 和 `deltaSellForce (dS)` 的符号与绝对值如何？是否呈现多增空减或空增多减的清晰格局？
        *   **短期趋势**: `LongIntRatio (f4_1)` 和 `ShortIntRatio (f4_2)` 的表现如何？多头或空头的持仓趋势（对比5日前）是在加强还是在减弱？

    2.  **评估净持仓情绪（整体倾向）**：
        *   **情绪变化**: `NetIntChg (f1)` 是正还是负？这表明会员净多头寸（多头-空头）在过去5天是增长还是萎缩？
        *   **情绪现状**: `NetIntRatio (f3)` 的数值是多少？它揭示了当前会员的净多头寸在其总持仓（多头+空头）中的占比，反映了整体情绪的强烈程度。

    3.  **评估市场相对强度（主力与市场的关系）**：
        *   **相对变化**: `NetIntTotalChg (f2)`、`LongRelTotIntChg (f5_1)` 和 `ShortRelTotIntChg (f5_2)` 的符号是什么？这说明与市场总持仓量(openint)相比，会员的多头、空头或净多头寸的“市场份额”是在增加还是减少？
        *   **相对现状**: `LongShortSenti (f6)` 的数值是多少？它直接量化了会员净多头寸占市场总持仓的比例，反映了主力资金在市场中的影响力。

    4.  **综合判断与信号提炼**：
        *   **一致性检查**：上述三个维度的分析结果是否指向同一个方向？例如，是否同时出现“多头持仓增加、净多头情绪向好、多头市场份额扩大”的看多共振信号？
        *   **矛盾点识别**：是否存在关键因子相互矛盾的情况？若存在，则信号不明确。


以下是短期记忆:
{short_terms}

以下是中期记忆:
{mid_terms}

以下是长期记忆:
{long_terms}

以下是过去反思记忆:
{reflection_terms}

你不是要预测未来，而是要根据当前信息和既定规则，做出当下最优的概率决策。

必须严格按照以下JSON格式返回,reasoning内容必须中文描述:
confidence:在0~100之间，数值越大，置信度越高
{{
"short_memory_index": "S1,S2,S3",
"mid_memory_index":"M1,M2,M3",
"long_memory_index":"L1,L2,L3",
"reflection_memory_index":"R1,R2,R3",
"reasoning": "string",
"confidence": "int",
"signal": "bullish/bearish/neutral",
"analysis_details": "string (trend indicators, etc.)",
}}
"""
